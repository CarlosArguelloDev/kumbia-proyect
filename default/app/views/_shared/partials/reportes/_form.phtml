<?= Form::openMultipart() ?>


<div class="row">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h6>Datos del reporte</h6>
            </div>
            <div class="card-body">

                <?= Bform::text_label("Título", "reporte.titulo", ["placeholder" => "Agrega un titulo", "required" => "required"]) ?>
                <br>

                <label class="form-label">Descripción</label>
                <?= Form::textarea("reporte.descripcion", ["class" => "form-control", "rows" => 3, "placeholder" => "Agrega una descripción", "required" => "required"]) ?>
                <br>

                <label class="form-label">Diámetro (cm)</label>
                <?= Form::number("reporte.diametro", ["class" => "form-control", "min" => 1, "step" => "0.01", "placeholder" => "ej: 55.33", "required" => "required"]) ?>
                <br>
                <?= Bform::text_label("Dirección", "reporte.direccion", ["id" => "direccion", "placeholder" => "Agrega una dirección", "required" => "required"]) ?>
                <br>
                <input type="hidden" name="reporte[latitud]" id="latitud">
                <input type="hidden" name="reporte[longitud]" id="longitud">
                <label>Fotografía</label>
                <?php
                // En modo edición, la foto es opcional
                $fotoRequired = (isset($reporte) && $reporte->id) ? [] : ["required" => "required"];
                ?>
                <?= Form::file("foto", array_merge(["class" => "form-control"], $fotoRequired)) ?>
                <small class="text-muted">Formatos recomendados:
                    JPG.<?= (isset($reporte) && $reporte->id) ? ' Dejar vacío para mantener la foto actual.' : '' ?></small>

            </div>

        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <h6>Ubicación en el mapa</h6>
            </div>
            <div class="card-body">

                <label>Selecciona ubicación en el mapa</label>
                <div class="mb-2">
                    <button type="button" id="btn-usar-ubicacion" class="btn btn-primary btn-sm">
                        <i class="bi bi-geo-alt-fill"></i> Usar mi ubicación
                    </button>
                </div>
                <div id="map" style="height: 380px; border-radius:12px;"></div>
                <small class="text-muted">
                    Da click para poner marcador o arrástralo para ajustar.
                </small>

            </div>
            <div class="card-footer text-end">
                <?php
                $btnText = (isset($reporte) && $reporte->id) ? "Actualizar reporte" : "Realizar reporte";
                ?>
                <?= Bform::btn_aceptar($btnText) ?>
            </div>
        </div>
    </div>
</div>

<?= Form::close() ?>


<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="">
    </script>

<script>
    // Centro inicial (Querétaro / SJR)
    <?php if (isset($reporte) && $reporte->id && $reporte->latitud && $reporte->longitud): ?>
        // Si hay un reporte existente, usar sus coordenadas
        const centro = [<?= $reporte->latitud ?>, <?= $reporte->longitud ?>];
        const direccionInicial = "<?= addslashes($reporte->direccion ?? '') ?>";
    <?php else: ?>
        // Centro por defecto
        const centro = [20.3712465, -99.9830166];
        const direccionInicial = "";
    <?php endif; ?>

    const map = L.map('map').setView(centro, 14);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = L.marker(centro, { draggable: true }).addTo(map);

    function setLocation(lat, lng, updateAddress = true) {
        document.getElementById("latitud").value = lat;
        document.getElementById("longitud").value = lng;

        // Reverse geocoding (Nominatim) -> autollenar dirección
        if (updateAddress) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
                .then(r => r.json())
                .then(data => {
                    if (data && data.display_name) {
                        const dirInput = document.getElementById("direccion");
                        if (dirInput) {
                            dirInput.value = data.display_name;
                        }
                    }
                })
                .catch(() => { });
        }
    }

    // Inicializar ubicación
    setLocation(centro[0], centro[1], !direccionInicial);

    // Si hay dirección inicial (modo edición), establecerla
    if (direccionInicial) {
        document.getElementById("direccion").value = direccionInicial;
    }

    // Botón para usar ubicación del usuario
    document.getElementById("btn-usar-ubicacion").addEventListener("click", function() {
        if (navigator.geolocation) {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Obteniendo ubicación...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Mover el mapa y el marcador a la ubicación del usuario
                    map.setView([lat, lng], 16);
                    marker.setLatLng([lat, lng]);
                    setLocation(lat, lng, true);
                    
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Usar mi ubicación';
                },
                (error) => {
                    alert("No se pudo obtener tu ubicación. Por favor, verifica los permisos del navegador.");
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Usar mi ubicación';
                }
            );
        } else {
            alert("Tu navegador no soporta geolocalización.");
        }
    });

    map.on('click', function (e) {
        marker.setLatLng(e.latlng);
        setLocation(e.latlng.lat, e.latlng.lng, true);
    });

    marker.on('dragend', function (e) {
        const p = e.target.getLatLng();
        setLocation(p.lat, p.lng, true);
    });
</script>